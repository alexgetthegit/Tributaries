<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>360 Sky • Desktop Move + WebXR</title>
  <style>
    html, body { margin:0; height:100%; background:#000; }
    #hint {
      position:fixed; inset:auto 0 16px 0; display:flex; justify-content:center;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      pointer-events:none;
    }
    #hint .bubble {
      pointer-events:auto; background:rgba(0,0,0,.55); color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.25); font-size:14px
    }
    #hint .bubble button { margin-left:10px; padding:6px 10px; border:0; border-radius:8px; cursor:pointer }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- Hidden 360 sky video -->
  <video id="pano" playsinline muted loop preload="metadata"
         crossorigin="anonymous" style="display:none"></video>

  <div id="hint">
    <div class="bubble">
      Click “Enable Mouse Look”, then use <b>W/A/S/D</b> (or arrows) to move · Press <b>Esc</b> to release
      <button id="lockBtn">Enable Mouse Look</button>
    </div>
  </div>

  <!-- Import map for Three -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/controls/PointerLockControls.js": "https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js",
      "three/addons/webxr/XRButton.js": "https://unpkg.com/three@0.160.0/examples/jsm/webxr/XRButton.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
    import { XRButton } from 'three/addons/webxr/XRButton.js';

    // --- Renderer / scene / camera ---
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 1.5));
    renderer.setSize(innerWidth, innerHeight);
    renderer.xr.enabled = true;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(XRButton.createButton(renderer, { optionalFeatures:['local-floor','bounded-floor'] }));

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 200);
    camera.position.set(0, 1.6, 3);

    // Soft light for floor visibility
    scene.add(new THREE.HemisphereLight(0xbfd8ff, 0x202020, 0.6));

    // --- Flat floor (10×10 m) ---
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(10, 10),
      new THREE.MeshStandardMaterial({ color: 0x2f3338, roughness: 1.0 })
    );
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    // --- 360° SKY VIDEO (top hemisphere) ---
    const panoEl = document.getElementById('pano');
    panoEl.src = 'videos/sky360.mp4'; // <- your file

    let skyMesh = null;
    function buildVideoSky(video) {
      // Only the upper half-sphere so no ground is visible
      const geo = new THREE.SphereGeometry(50, 64, 32, 0, Math.PI*2, 0, Math.PI/2);
      geo.scale(-1, 1, 1); // look inward

      const tex = new THREE.VideoTexture(video);
      tex.colorSpace = THREE.SRGBColorSpace;
      tex.minFilter = THREE.LinearFilter;
      tex.magFilter = THREE.LinearFilter;
      tex.generateMipmaps = false;

      skyMesh = new THREE.Mesh(new THREE.MeshBasicMaterial({ map: tex, toneMapped:false }));
      skyMesh.geometry = geo;
      scene.add(skyMesh);
    }

    async function tryStartVideo(){
      try { await panoEl.play(); } catch {}
      if (!skyMesh && !panoEl.paused) buildVideoSky(panoEl);
    }
    // Start on user gesture and on XR session start
    addEventListener('pointerdown', tryStartVideo, { once:true });
    renderer.xr.addEventListener('sessionstart', tryStartVideo);
    document.addEventListener('visibilitychange', ()=> document.hidden ? panoEl.pause() : tryStartVideo());

    // --- Desktop first-person controls (Pointer Lock + WASD) ---
    const controls = new PointerLockControls(camera, renderer.domElement);
    const hint = document.getElementById('hint');
    const lockBtn = document.getElementById('lockBtn');

    // Lock/unlock UI
    lockBtn.addEventListener('click', () => { controls.lock(); tryStartVideo(); });
    controls.addEventListener('lock',  () => hint.classList.add('hidden'));
    controls.addEventListener('unlock',()=> hint.classList.remove('hidden'));

    // Movement state
    const keys = { forward:false, back:false, left:false, right:false };
    addEventListener('keydown', (e)=>{
      switch(e.code){
        case 'KeyW': case 'ArrowUp':    keys.forward = true; break;
        case 'KeyS': case 'ArrowDown':  keys.back    = true; break;
        case 'KeyA': case 'ArrowLeft':  keys.left    = true; break;
        case 'KeyD': case 'ArrowRight': keys.right   = true; break;
      }
    });
    addEventListener('keyup', (e)=>{
      switch(e.code){
        case 'KeyW': case 'ArrowUp':    keys.forward = false; break;
        case 'KeyS': case 'ArrowDown':  keys.back    = false; break;
        case 'KeyA': case 'ArrowLeft':  keys.left    = false; break;
        case 'KeyD': case 'ArrowRight': keys.right   = false; break;
      }
    });

    // Simple FPS-style movement (XZ only), clamped to a 10×10 area
    const vel = new THREE.Vector3();
    const dir = new THREE.Vector3();
    const SPEED = 2.0;        // m/s
    const DAMP  = 8.0;        // higher = snappier stop
    const HALF  = 5.0 - 0.1;  // bounds (room half-size minus margin)

    function updateDesktopMovement(dt){
      if (!controls.isLocked) return;
      dir.set(
        (keys.right? 1:0) - (keys.left? 1:0),
        0,
        (keys.back? 1:0) - (keys.forward? 1:0)
      ).normalize();

      // accelerate toward wish direction in camera space
      if (dir.lengthSq() > 0){
        const forward = new THREE.Vector3();
        controls.getDirection(forward); // camera forward
        forward.y = 0; forward.normalize();
        const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0,1,0)).negate();
        const wish = new THREE.Vector3()
          .addScaledVector(forward, -dir.z)
          .addScaledVector(right,    dir.x)
          .setLength(SPEED);
        vel.lerp(wish, Math.min(1, dt*DAMP));
      } else {
        vel.lerp(new THREE.Vector3(0,0,0), Math.min(1, dt*DAMP));
      }

      // apply motion (keep y fixed ~1.6)
      const deltaMove = vel.clone().multiplyScalar(dt);
      controls.moveRight(deltaMove.x);
      controls.moveForward(deltaMove.z);

      // clamp inside a ~10×10 square
      const pos = controls.getObject().position;
      pos.x = THREE.MathUtils.clamp(pos.x, -HALF, HALF);
      pos.z = THREE.MathUtils.clamp(pos.z, -HALF, HALF);
      pos.y = 1.6; // keep “eye height” steady
    }

    // --- Animation loop ---
    const clock = new THREE.Clock();
    renderer.setAnimationLoop(()=>{
      const dt = Math.min(0.05, clock.getDelta());

      // Only run keyboard/mouse movement when NOT in XR
      if (!renderer.xr.isPresenting) updateDesktopMovement(dt);

      renderer.render(scene, camera);
    });

    // --- Resize ---
    addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
